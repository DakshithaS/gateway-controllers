name: Publish Policy

on:
  workflow_dispatch:
    inputs:
      policy:
        description: 'Policy name (e.g., rate-limit)'
        required: true
        type: string
      version:
        description: 'Version (SemVer format: X.Y.Z or X.Y.Z-dev.N or X.Y.Z-rc.N)'
        required: true
        type: string

jobs:
  validate-and-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write  # for creating tags
      actions: read    # for checkout
    
    steps:
    - name: Validate inputs
      run: |
        # Validate policy name (alphanumeric, hyphens only)
        if ! echo "${{ github.event.inputs.policy }}" | grep -E '^[a-zA-Z0-9-]+$'; then
          echo "âŒ Policy name must contain only alphanumeric characters and hyphens"
          exit 1
        fi
        
        # Validate version format more strictly
        if ! echo "${{ github.event.inputs.version }}" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+(-(dev|rc)\.[0-9]+)?$'; then
          echo "âŒ Version must be valid SemVer (e.g., 1.0.0, 1.0.0-dev.1, 1.0.0-rc.1)"
          exit 1
        fi
        
        echo "âœ… Input validation passed"

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tag checking

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'
        cache: true
        cache-dependency-path: 'policies/${{ github.event.inputs.policy }}/go.sum'



    - name: Parse and validate version
      id: version-validation
      run: |
        VERSION="${{ github.event.inputs.version }}"
        POLICY="${{ github.event.inputs.policy }}"
        
        # Extract major, minor, patch
        MAJOR=$(echo "$VERSION" | cut -d. -f1)
        MINOR=$(echo "$VERSION" | cut -d. -f2)
        PATCH=$(echo "$VERSION" | cut -d. -f3 | sed 's/-.*//')
        
        # Determine module path and target directory
        if [ "$MAJOR" = "0" ] || [ "$MAJOR" = "1" ]; then
          MODULE_PATH="github.com/DakshithaS/gateway-controllers/policies/$POLICY"
          TARGET_DIR="policies/$POLICY"
        else
          MODULE_PATH="github.com/DakshithaS/gateway-controllers/policies/$POLICY/v$MAJOR"
          TARGET_DIR="policies/$POLICY/v$MAJOR"
        fi
        
        TAG_NAME="policies/$POLICY/v$VERSION"
        
        echo "âœ… Version format valid: $VERSION"
        echo "major=$MAJOR" >> $GITHUB_OUTPUT
        echo "minor=$MINOR" >> $GITHUB_OUTPUT
        echo "patch=$PATCH" >> $GITHUB_OUTPUT
        echo "module-path=$MODULE_PATH" >> $GITHUB_OUTPUT
        echo "target-dir=$TARGET_DIR" >> $GITHUB_OUTPUT
        echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT



    - name: Validate policy structure
      run: |
        TARGET_DIR="${{ steps.version-validation.outputs.target-dir }}"
        
        # Check if base policy directory exists first
        if [ ! -d "policies/${{ github.event.inputs.policy }}" ]; then
          echo "âŒ Policy '${{ github.event.inputs.policy }}' does not exist"
          echo "Available policies:"
          ls -1 policies/ 2>/dev/null || echo "No policies directory found"
          exit 1
        fi
        
        if [ ! -d "$TARGET_DIR" ]; then
          echo "âŒ Policy directory $TARGET_DIR does not exist"
          echo "Expected structure for major version ${{ steps.version-validation.outputs.major }}:"
          echo "  - v0/v1: policies/${{ github.event.inputs.policy }}/"
          echo "  - v2+: policies/${{ github.event.inputs.policy }}/v${{ steps.version-validation.outputs.major }}/"
          exit 1
        fi
        
        # Check required files
        for file in "go.mod" "policy-definition.yaml"; do
          if [ ! -f "$TARGET_DIR/$file" ]; then
            echo "âŒ $file not found in $TARGET_DIR"
            exit 1
          fi
        done
        
        # Validate go.mod module path
        EXPECTED_MODULE="${{ steps.version-validation.outputs.module-path }}"
        ACTUAL_MODULE=$(head -n1 "$TARGET_DIR/go.mod" | awk '{print $2}')
        
        if [ "$ACTUAL_MODULE" != "$EXPECTED_MODULE" ]; then
          echo "âŒ go.mod module path mismatch"
          echo "Expected: $EXPECTED_MODULE"
          echo "Actual: $ACTUAL_MODULE"
          exit 1
        fi
        
        echo "âœ… Policy structure validation passed"

    - name: Run policy tests
      working-directory: ${{ steps.version-validation.outputs.target-dir }}
      run: |
        echo "Running tests in ${{ steps.version-validation.outputs.target-dir }}"
        
        # Run tests with race detection and verbose output
        if ! go test -v -race ./...; then
          echo "âŒ Tests failed â€” release aborted"
          exit 1
        fi
        
        echo "âœ… All tests passed"

    - name: Ensure version is new
      run: |
        TAG_NAME="${{ steps.version-validation.outputs.tag-name }}"
        
        if git tag -l | grep -q "^$TAG_NAME$"; then
          echo "âŒ Version ${{ github.event.inputs.version }} already exists (tag: $TAG_NAME)"
          exit 1
        fi
        
        echo "âœ… Version ${{ github.event.inputs.version }} is new"

    - name: Create Git tag
      run: |
        TAG_NAME="${{ steps.version-validation.outputs.tag-name }}"
        
        # Use GitHub Actions bot identity
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # Create annotated tag with message
        git tag -a "$TAG_NAME" -m "Release ${{ github.event.inputs.policy }} v${{ github.event.inputs.version }}"
        git push origin "$TAG_NAME"
        
        echo "âœ… Created and pushed tag: $TAG_NAME"

    - name: Verify Go module resolution
      run: |
        MODULE_PATH="${{ steps.version-validation.outputs.module-path }}"
        VERSION_TAG="v${{ github.event.inputs.version }}"
        
        echo "Testing module resolution: $MODULE_PATH@$VERSION_TAG"
        
        # Wait for tag to propagate and retry module resolution
        for i in {1..3}; do
          echo "Attempt $i/3..."
          if go list -m "$MODULE_PATH@$VERSION_TAG" 2>/dev/null; then
            echo "âœ… Go module resolution successful"
            exit 0
          fi
          if [ $i -lt 3 ]; then
            echo "âš ï¸  Failed, waiting 15 seconds before retry..."
            sleep 15
          fi
        done
        
        echo "âŒ Go cannot resolve module $MODULE_PATH@$VERSION_TAG after 3 attempts"
        echo "This might be due to Git tag propagation delay or network issues"
        exit 1

    - name: Register policy in Policy Hub
      run: |
        echo "ðŸ“ Registering policy in Policy Hub..."
        
        MODULE_PATH="${{ steps.version-validation.outputs.module-path }}"
        TARGET_DIR="${{ steps.version-validation.outputs.target-dir }}"
        TAG_NAME="${{ steps.version-validation.outputs.tag-name }}"
        
        # Create registration payload with structured data
        POLICY_DATA=$(jq -n \
          --arg policy "${{ github.event.inputs.policy }}" \
          --arg version "${{ github.event.inputs.version }}" \
          --arg module_path "$MODULE_PATH" \
          --arg git_tag "$TAG_NAME" \
          --arg repository "${{ github.repository }}" \
          --arg commit_sha "${{ github.sha }}" \
          --rawfile policy_def "$TARGET_DIR/policy-definition.yaml" \
          '{
            policy: $policy,
            version: $version,
            module_path: $module_path,
            git_tag: $git_tag,
            repository: $repository,
            commit_sha: $commit_sha,
            policy_definition: $policy_def,
            published_at: now | strftime("%Y-%m-%dT%H:%M:%SZ")
          }')
        
        echo "Policy registration data prepared:"
        echo "$POLICY_DATA" | jq .
        
        # Placeholder API call - replace with actual Policy Hub endpoint
        # curl -X POST https://policy-hub-api.example.com/register \
        #   -H "Authorization: Bearer ${{ secrets.POLICY_HUB_TOKEN }}" \
        #   -H "Content-Type: application/json" \
        #   -d "$POLICY_DATA"
        
        echo "âš ï¸  Policy Hub registration is currently a placeholder"
        echo "Implement the actual API call to your Policy Hub service"
        
        echo "âœ… Policy registration step completed (placeholder)"

    - name: Summary
      run: |
        MODULE_PATH="${{ steps.version-validation.outputs.module-path }}"
        TAG_NAME="${{ steps.version-validation.outputs.tag-name }}"
        
        echo "ðŸŽ‰ Policy publication completed successfully!"
        echo ""
        echo "ðŸ“¦ Policy: ${{ github.event.inputs.policy }}"
        echo "ðŸ·ï¸  Version: ${{ github.event.inputs.version }}"
        echo "ðŸ·ï¸  Tag: $TAG_NAME"
        echo "ðŸ“š Module: $MODULE_PATH"
        echo "ðŸ”— Repository: https://github.com/${{ github.repository }}"
        echo ""
        echo "âœ… Git tag created and pushed"
        echo "âœ… Go module resolution verified"
        echo "âœ… Policy Hub registration prepared"
        echo ""
        echo "ðŸš€ Ready for use!"
        
        # Create GitHub step summary
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # ðŸŽ‰ Policy Published Successfully
        
        | Item | Value |
        |------|-------|
        | **Policy** | \`${{ github.event.inputs.policy }}\` |
        | **Version** | \`${{ github.event.inputs.version }}\` |
        | **Git Tag** | \`$TAG_NAME\` |
        | **Go Module** | \`$MODULE_PATH\` |
        | **Repository** | [${{ github.repository }}](https://github.com/${{ github.repository }}) |
        
        ## Usage
        
        \`\`\`bash
        go get $MODULE_PATH@v${{ github.event.inputs.version }}
        \`\`\`
        
        ## Status
        - âœ… Git tag created and pushed
        - âœ… Go module resolution verified  
        - âœ… Policy Hub registration prepared
        EOF