name: Publish Policy

on:
  workflow_dispatch:
    inputs:
      policy:
        description: "Policy folder name (e.g., ratelimit)"
        required: true
        type: string
      version:
        description: "Version (SemVer: X.Y.Z | X.Y.Z-dev.N | X.Y.Z-rc.N)"
        required: true
        type: string

permissions:
  contents: write
  actions: read
  workflows: write

jobs:
  publish-policy:
    name: Validate, Test & Publish Policy
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # âœ… Enforce main branch only
    if: github.ref == 'refs/heads/main'

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Input validation
      # ------------------------------------------------------------
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          POLICY="${{ github.event.inputs.policy }}"
          VERSION="${{ github.event.inputs.version }}"

          if ! [[ "$POLICY" =~ ^[a-zA-Z0-9-]+$ ]]; then
            echo "âŒ Invalid policy name: $POLICY"
            exit 1
          fi

          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(dev|rc)\.[0-9]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            exit 1
          fi

          echo "âœ… Inputs validated"

      # ------------------------------------------------------------
      # Go setup
      # ------------------------------------------------------------
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache: true

      # ------------------------------------------------------------
      # Resolve version & paths
      # ------------------------------------------------------------
      - name: Resolve module metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          POLICY="${{ github.event.inputs.policy }}"
          VERSION="${{ github.event.inputs.version }}"
          MAJOR="${VERSION%%.*}"

          if [[ "$MAJOR" == "0" || "$MAJOR" == "1" ]]; then
            TARGET_DIR="policies/$POLICY"
            MODULE_PATH="github.com/DakshithaS/gateway-controllers/policies/$POLICY"
          else
            TARGET_DIR="policies/$POLICY/v$MAJOR"
            MODULE_PATH="github.com/DakshithaS/gateway-controllers/policies/$POLICY/v$MAJOR"
          fi

          TAG_NAME="policies/$POLICY/v$VERSION"

          echo "target_dir=$TARGET_DIR" >> "$GITHUB_OUTPUT"
          echo "module_path=$MODULE_PATH" >> "$GITHUB_OUTPUT"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"

          echo "âœ… Metadata resolved"

      # ------------------------------------------------------------
      # Policy structure validation
      # ------------------------------------------------------------
      - name: Validate policy structure
        shell: bash
        run: |
          set -euo pipefail

          DIR="${{ steps.meta.outputs.target_dir }}"

          [[ -d "$DIR" ]] || { echo "âŒ Missing directory: $DIR"; exit 1; }

          for f in go.mod policy-definition.yaml; do
            [[ -f "$DIR/$f" ]] || { echo "âŒ Missing $f in $DIR"; exit 1; }
          done

          EXPECTED="${{ steps.meta.outputs.module_path }}"
          ACTUAL=$(awk 'NR==1 {print $2}' "$DIR/go.mod")

          [[ "$EXPECTED" == "$ACTUAL" ]] || {
            echo "âŒ go.mod module mismatch"
            echo "Expected: $EXPECTED"
            echo "Actual:   $ACTUAL"
            exit 1
          }

          echo "âœ… Policy structure valid"

      # ------------------------------------------------------------
      # Tests
      # ------------------------------------------------------------
      - name: Run policy tests
        working-directory: ${{ steps.meta.outputs.target_dir }}
        shell: bash
        run: |
          set -euo pipefail
          go test -v -race ./...

      # ------------------------------------------------------------
      # Git hygiene
      # ------------------------------------------------------------
      - name: Ensure clean working tree
        shell: bash
        run: |
          set -euo pipefail
          git diff --exit-code
          test -z "$(git status --porcelain)"

      # ------------------------------------------------------------
      # Ensure version uniqueness
      # ------------------------------------------------------------
      - name: Ensure version is new
        shell: bash
        run: |
          set -euo pipefail
          git tag -l | grep -qx "${{ steps.meta.outputs.tag_name }}" && {
            echo "âŒ Tag already exists"
            exit 1
          } || echo "âœ… Version is new"

      # ------------------------------------------------------------
      # Create Git tag
      # ------------------------------------------------------------
      - name: Create and push tag
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git tag -a "${{ steps.meta.outputs.tag_name }}" \
            -m "Release ${{ github.event.inputs.policy }} v${{ github.event.inputs.version }}"

          git push origin "${{ steps.meta.outputs.tag_name }}"

      # ------------------------------------------------------------
      # Verify Go module resolution
      # ------------------------------------------------------------
      - name: Verify Go module resolution
        shell: bash
        run: |
          set -euo pipefail

          MOD="${{ steps.meta.outputs.module_path }}"
          VER="v${{ github.event.inputs.version }}"

          for i in 1 2 3; do
            if go list -m "$MOD@$VER"; then
              echo "âœ… Module resolved"
              exit 0
            fi
            sleep 15
          done

          echo "âŒ Go module resolution failed"
          exit 1

      # ------------------------------------------------------------
      # Register Policy in Policy Hub (Non-blocking)
      # ------------------------------------------------------------
      - name: Register policy in Policy Hub
        id: policy-hub
        shell: bash
        env:
          POLICY_HUB_URL: ${{ secrets.POLICY_HUB_URL }}
          POLICY_HUB_TOKEN: ${{ secrets.POLICY_HUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "ðŸ“ Registering policy in Policy Hub..."

          # Skip if Policy Hub credentials not configured
          if [[ -z "${POLICY_HUB_URL:-}" || -z "${POLICY_HUB_TOKEN:-}" ]]; then
            echo "âš ï¸ Policy Hub credentials not configured - skipping registration"
            echo "registration_status=skipped" >> "$GITHUB_OUTPUT"
            echo "registration_message=Policy Hub credentials not configured" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PAYLOAD=$(jq -n \
            --arg policy "${{ github.event.inputs.policy }}" \
            --arg version "${{ github.event.inputs.version }}" \
            --arg module_path "${{ steps.meta.outputs.module_path }}" \
            --arg git_tag "${{ steps.meta.outputs.tag_name }}" \
            --arg repository "${{ github.repository }}" \
            --arg commit_sha "${{ github.sha }}" \
            --rawfile policy_def "${{ steps.meta.outputs.target_dir }}/policy-definition.yaml" \
            '{
              policy: $policy,
              version: $version,
              module_path: $module_path,
              git_tag: $git_tag,
              repository: $repository,
              commit_sha: $commit_sha,
              policy_definition: $policy_def,
              published_at: now | strftime("%Y-%m-%dT%H:%M:%SZ")
            }')

          # Attempt registration with error handling
          if HTTP_RESPONSE=$(curl -sSL -w "HTTPSTATUS:%{http_code}" \
            -X POST "$POLICY_HUB_URL/policies/register" \
            -H "Authorization: Bearer $POLICY_HUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" 2>&1); then
            
            HTTP_STATUS=$(echo "$HTTP_RESPONSE" | tr -d '\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\1/')
            RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | sed -E 's/HTTPSTATUS:[0-9]{3}$//')
            
            if [[ "$HTTP_STATUS" =~ ^(200|201)$ ]]; then
              echo "âœ… Policy registered successfully in Policy Hub"
              echo "registration_status=success" >> "$GITHUB_OUTPUT"
              echo "registration_message=Policy registered successfully" >> "$GITHUB_OUTPUT"
            else
              echo "âŒ Policy Hub registration failed (HTTP $HTTP_STATUS)"
              echo "Response: $RESPONSE_BODY"
              echo "registration_status=failed" >> "$GITHUB_OUTPUT"
              echo "registration_message=HTTP $HTTP_STATUS: $RESPONSE_BODY" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "âŒ Policy Hub registration failed - network/connection error"
            echo "Error: $HTTP_RESPONSE"
            echo "registration_status=failed" >> "$GITHUB_OUTPUT"
            echo "registration_message=Network error: $HTTP_RESPONSE" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------------------
      # Summary
      # ------------------------------------------------------------
      - name: Publish summary
        run: |
          # Determine Policy Hub status for summary
          case "${{ steps.policy-hub.outputs.registration_status }}" in
            "success")
              HUB_STATUS="âœ… Policy Hub registered"
              HUB_DETAILS=""
              ;;
            "skipped")
              HUB_STATUS="âš ï¸ Policy Hub registration skipped"
              HUB_DETAILS="Configure POLICY_HUB_URL and POLICY_HUB_TOKEN secrets to enable automatic registration"
              ;;
            "failed")
              HUB_STATUS="âŒ Policy Hub registration failed"
              HUB_DETAILS="Use 'Complete Policy Registration' workflow to retry registration"
              ;;
            *)
              HUB_STATUS="â“ Policy Hub status unknown"
              HUB_DETAILS=""
              ;;
          esac

          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # ðŸŽ‰ Policy Published Successfully

          | Item | Value |
          |------|------|
          | Policy | \`${{ github.event.inputs.policy }}\` |
          | Version | \`${{ github.event.inputs.version }}\` |
          | Tag | \`${{ steps.meta.outputs.tag_name }}\` |
          | Go Module | \`${{ steps.meta.outputs.module_path }}\` |

          ## Usage
          \`\`\`bash
          go get ${{ steps.meta.outputs.module_path }}@v${{ github.event.inputs.version }}
          \`\`\`

          ## Status
          âœ… Tests passed  
          âœ… Tag created  
          âœ… Module verified  
          $HUB_STATUS

          $HUB_DETAILS
          EOF
