name: PR Checks

on:
  pull_request_target:
    branches:
      - main
      - '*.*.0'
    paths:
      - 'policies/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  pr-checks:
    name: Go PR Validation
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.3"
          cache: false

      - name: Install Go tools
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go install honnef.co/go/tools/cmd/staticcheck@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest
          go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Detect changed policies
        id: policies
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          POLICIES=$(git diff --name-only "$BASE" "$HEAD" | grep '^policies/' | while read -r f; do
            d=$(dirname "$f")
            while [[ "$d" != "policies" && "$d" != "." ]]; do
              [[ -f "$d/go.mod" ]] && echo "${d#policies/}" && break
              d=$(dirname "$d")
            done
          done | sort -u)

          echo "Detected policies: $POLICIES"

          if [[ -z "$POLICIES" ]]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "policies<<EOF" >> $GITHUB_OUTPUT
            echo "$POLICIES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Build policies
        id: build
        if: steps.policies.outputs.has_changes == 'true'
        run: |
          BUILD_FAILED=false
          SUMMARY_FILE=$(mktemp)
          echo "${{ steps.policies.outputs.policies }}" | while read -r policy; do
            echo "Building policy: $policy"
            if cd "policies/$policy" 2>/dev/null; then
              if ! go build . > build.out 2>&1; then
                BUILD_FAILED=true
                echo "### $policy" >> $SUMMARY_FILE
                echo "- Build failed" >> $SUMMARY_FILE
                cat build.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Build successful for $policy"
              fi
              cd ../..
            else
              BUILD_FAILED=true
              echo "### $policy" >> $SUMMARY_FILE
              echo "- Directory not found" >> $SUMMARY_FILE
              echo "" >> $SUMMARY_FILE
            fi
          done
          SUMMARY=$(cat $SUMMARY_FILE)
          echo "build_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "build_failed=$BUILD_FAILED" >> $GITHUB_OUTPUT

      - name: Run checks on policies
        id: checks
        if: steps.policies.outputs.has_changes == 'true' && steps.build.outputs.build_failed != 'true'
        run: |
          SUMMARY_FILE=$(mktemp)
          echo "${{ steps.policies.outputs.policies }}" | while read -r policy; do
            echo "Checking policy: $policy"
            if cd "policies/$policy" 2>/dev/null; then
              # Formatting check
              if ! goimports -d . > goimports.out 2>&1; then
                echo "Formatting failed for $policy"
                echo "### $policy" >> $SUMMARY_FILE
                echo "- Formatting failed" >> $SUMMARY_FILE
                cat goimports.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Formatting successful for $policy"
              fi
              # Static check
              if ! staticcheck ./... > staticcheck.out 2>&1; then
                echo "Static check failed for $policy"
                if ! grep -q "### $policy" $SUMMARY_FILE; then echo "### $policy" >> $SUMMARY_FILE; fi
                echo "- Static check failed" >> $SUMMARY_FILE
                cat staticcheck.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Static check successful for $policy"
              fi
              # Vulnerability check
              if ! govulncheck ./... > govulncheck.out 2>&1; then
                echo "Vulnerability check failed for $policy"
                if ! grep -q "### $policy" $SUMMARY_FILE; then echo "### $policy" >> $SUMMARY_FILE; fi
                echo "- Vulnerability check failed" >> $SUMMARY_FILE
                cat govulncheck.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Vulnerability check successful for $policy"
              fi
              # Gosec check
              if ! gosec ./... > gosec.out 2>&1; then
                echo "Gosec check failed for $policy"
                if ! grep -q "### $policy" $SUMMARY_FILE; then echo "### $policy" >> $SUMMARY_FILE; fi
                echo "- Gosec check failed" >> $SUMMARY_FILE
                cat gosec.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Gosec check successful for $policy"
              fi
              # Tests
              if ! go test ./... > test.out 2>&1; then
                echo "Tests failed for $policy"
                if ! grep -q "### $policy" $SUMMARY_FILE; then echo "### $policy" >> $SUMMARY_FILE; fi
                echo "- Tests failed" >> $SUMMARY_FILE
                cat test.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Tests successful for $policy"
              fi
              # Tests with race
              if ! go test -race ./... > test_race.out 2>&1; then
                echo "Tests with race failed for $policy"
                if ! grep -q "### $policy" $SUMMARY_FILE; then echo "### $policy" >> $SUMMARY_FILE; fi
                echo "- Tests with race failed" >> $SUMMARY_FILE
                cat test_race.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Tests with race successful for $policy"
              fi
              cd ../..
            else
              echo "Directory not found for checks for $policy"
              echo "### $policy" >> $SUMMARY_FILE
              echo "- Directory not found for checks" >> $SUMMARY_FILE
              echo "" >> $SUMMARY_FILE
            fi
          done
          SUMMARY=$(cat $SUMMARY_FILE)
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: steps.policies.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            let body = '## PR Checks Summary\n\n';
            const buildSummary = `${{ steps.build.outputs.build_summary }}`;
            if (buildSummary.trim()) {
              body += '### Build Failures\n' + buildSummary + '\n';
            }
            const checkSummary = `${{ steps.checks.outputs.summary }}`;
            if (checkSummary.trim()) {
              body += '### Check Failures\n' + checkSummary + '\n';
            }
            if (buildSummary.trim() || checkSummary.trim()) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      - name: Fail if build failed
        if: steps.build.outputs.build_failed == 'true'
        run: exit 1