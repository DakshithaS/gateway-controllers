name: PR Checks

on:
  pull_request_target:
    branches: [main, master]
    paths:
      - 'policies/**'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-checks:
    name: Build, Test & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      # ------------------------------------------------------------
      # Setup Go
      # ------------------------------------------------------------
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      # ------------------------------------------------------------
      # Install additional tools
      # ------------------------------------------------------------
      - name: Install formatting tools
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go install honnef.co/go/tools/cmd/staticcheck@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest

      # ------------------------------------------------------------
      # Find changed policies
      # ------------------------------------------------------------
      - name: Find changed policies
        id: changed-policies
        run: |
          # Get list of changed files
          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          fi

          # Find changed policy directories
          CHANGED_POLICIES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | \
            grep '^policies/' | \
            cut -d/ -f2 | \
            sort -u || true)

          if [[ -z "$CHANGED_POLICIES" ]]; then
            echo "No policy changes detected"
            echo "policies=" >> "$GITHUB_OUTPUT"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changed policies: $CHANGED_POLICIES"
            echo "policies<<EOF" >> "$GITHUB_OUTPUT"
            echo "$CHANGED_POLICIES" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------------------
      # Format check
      # ------------------------------------------------------------
      - name: Check Go formatting
        if: steps.changed-policies.outputs.has_changes == 'true'
        run: |
          echo "Checking Go formatting..."
          
          # Check if gofmt would make any changes
          UNFORMATTED=$(find policies/ -name "*.go" -exec gofmt -l {} +)
          
          if [[ -n "$UNFORMATTED" ]]; then
            echo "ERRORS<<EOF" >> $GITHUB_ENV
            echo "‚ùå The following files are not properly formatted:" >> $GITHUB_ENV
            echo "$UNFORMATTED" >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            echo "Run 'go fmt ./...' to fix formatting issues." >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            exit 1
          fi
          
          echo "‚úÖ All Go files are properly formatted"

      # ------------------------------------------------------------
      # Import check
      # ------------------------------------------------------------
      - name: Check Go imports
        if: steps.changed-policies.outputs.has_changes == 'true'
        run: |
          echo "Checking Go imports..."
          
          # Check if goimports would make any changes
          UNFORMATTED=$(find policies/ -name "*.go" -exec goimports -l {} +)
          
          if [[ -n "$UNFORMATTED" ]]; then
            echo "ERRORS<<EOF" >> $GITHUB_ENV
            echo "‚ùå The following files have import issues:" >> $GITHUB_ENV
            echo "$UNFORMATTED" >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            echo "Run 'goimports -w .' to fix import issues." >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            exit 1
          fi
          
          echo "‚úÖ All Go imports are properly formatted"

      # ------------------------------------------------------------
      # Vet check
      # ------------------------------------------------------------
      - name: Run go vet
        if: steps.changed-policies.outputs.has_changes == 'true'
        run: |
          echo "Running go vet on changed policies..."
          
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            
            echo "Checking policy: $policy"
            if output=$(cd "policies/$policy" && go vet ./... 2>&1); then
              echo "‚úÖ go vet passed for policy: $policy"
            else
              echo "ERRORS<<EOF" >> $GITHUB_ENV
              echo "‚ùå go vet failed for policy: $policy" >> $GITHUB_ENV
              echo "$output" >> $GITHUB_ENV
              echo "" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            fi
          done <<< "${{ steps.changed-policies.outputs.policies }}"

      # ------------------------------------------------------------
      # Static check
      # ------------------------------------------------------------
      - name: Run staticcheck
        if: steps.changed-policies.outputs.has_changes == 'true'
        run: |
          echo "Running staticcheck on changed policies..."
          
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            
            echo "Checking policy: $policy"
            if output=$(cd "policies/$policy" && staticcheck ./... 2>&1); then
              echo "‚úÖ staticcheck passed for policy: $policy"
            else
              echo "ERRORS<<EOF" >> $GITHUB_ENV
              echo "‚ùå staticcheck failed for policy: $policy" >> $GITHUB_ENV
              echo "$output" >> $GITHUB_ENV
              echo "" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            fi
          done <<< "${{ steps.changed-policies.outputs.policies }}"

      # ------------------------------------------------------------
      # Vulnerability check
      # ------------------------------------------------------------
      - name: Run govulncheck
        if: steps.changed-policies.outputs.has_changes == 'true'
        run: |
          echo "Running govulncheck on changed policies..."
          
          # Ensure govulncheck is in PATH
          export PATH="$PATH:$(go env GOPATH)/bin"
          
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            
            echo "Checking vulnerabilities in policy: $policy"
            output=$(cd "policies/$policy" && govulncheck ./... 2>&1 || true)
            exit_code=$?
            if [[ $exit_code -eq 0 ]]; then
              echo "‚úÖ govulncheck passed for policy: $policy"
            elif [[ $exit_code -eq 3 ]]; then
              echo "ERRORS<<EOF" >> $GITHUB_ENV
              echo "‚ùå Vulnerabilities found in policy: $policy" >> $GITHUB_ENV
              echo "$output" >> $GITHUB_ENV
              echo "" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            else
              echo "ERRORS<<EOF" >> $GITHUB_ENV
              echo "‚ùå govulncheck failed for policy: $policy" >> $GITHUB_ENV
              echo "$output" >> $GITHUB_ENV
              echo "" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            fi
          done <<< "${{ steps.changed-policies.outputs.policies }}"

      # ------------------------------------------------------------
      # Build check
      # ------------------------------------------------------------
      - name: Build policies
        if: steps.changed-policies.outputs.has_changes == 'true'
        run: |
          echo "Building changed policies..."
          
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            
            echo "Building policy: $policy"
            if output=$(cd "policies/$policy" && go build -v ./... 2>&1); then
              echo "‚úÖ Build passed for policy: $policy"
            else
              echo "ERRORS<<EOF" >> $GITHUB_ENV
              echo "‚ùå Build failed for policy: $policy" >> $GITHUB_ENV
              echo "$output" >> $GITHUB_ENV
              echo "" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            fi
          done <<< "${{ steps.changed-policies.outputs.policies }}"

      # ------------------------------------------------------------
      # Test policies
      # ------------------------------------------------------------
      - name: Test policies
        if: steps.changed-policies.outputs.has_changes == 'true'
        run: |
          echo "Testing changed policies..."
          
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            
            echo "Testing policy: $policy"
            if output=$(cd "policies/$policy" && go test -v -race -timeout=5m ./... 2>&1); then
              echo "‚úÖ Tests passed for policy: $policy"
            else
              echo "ERRORS<<EOF" >> $GITHUB_ENV
              echo "‚ùå Tests failed for policy: $policy" >> $GITHUB_ENV
              echo "$output" >> $GITHUB_ENV
              echo "" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            fi
          done <<< "${{ steps.changed-policies.outputs.policies }}"

      # ------------------------------------------------------------
      # Validate policy structure
      # ------------------------------------------------------------
      - name: Validate policy structure
        if: steps.changed-policies.outputs.has_changes == 'true'
        run: |
          echo "Validating policy structure..."
          
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            
            echo "Validating policy: $policy"
            
            POLICY_DIR="policies/$policy"
            POLICY_ERRORS=""
            
            # Check required files exist
            for file in go.mod policy-definition.yaml; do
              if [[ ! -f "$POLICY_DIR/$file" ]]; then
                POLICY_ERRORS+="‚ùå Missing required file: $POLICY_DIR/$file\n"
              fi
            done
            
            # Check at least one .go file exists
            if ! find "$POLICY_DIR" -name "*.go" -type f | grep -q .; then
              POLICY_ERRORS+="‚ùå No .go files found in $POLICY_DIR\n"
            fi
            
            # Validate go.mod module path
            if [[ -f "$POLICY_DIR/go.mod" ]]; then
              MODULE_PATH=$(grep '^module ' "$POLICY_DIR/go.mod" | awk '{print $2}')
              EXPECTED="github.com/DakshithaS/gateway-controllers/policies/$policy"
              
              if [[ "$MODULE_PATH" != "$EXPECTED"* ]]; then
                POLICY_ERRORS+="‚ùå Invalid module path in $POLICY_DIR/go.mod\n"
                POLICY_ERRORS+="   Expected: $EXPECTED\n"
                POLICY_ERRORS+="   Got: $MODULE_PATH\n"
              fi
            fi
            
            if [[ -n "$POLICY_ERRORS" ]]; then
              echo "ERRORS<<EOF" >> $GITHUB_ENV
              echo "‚ùå Policy structure validation failed for: $policy" >> $GITHUB_ENV
              echo "$POLICY_ERRORS" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            else
              echo "‚úÖ Policy structure validation passed for: $policy"
            fi
            
          done <<< "${{ steps.changed-policies.outputs.policies }}"

      # ------------------------------------------------------------
      # Check for errors and fail
      # ------------------------------------------------------------
      - name: Fail if errors found
        if: steps.changed-policies.outputs.has_changes == 'true'
        run: |
          if [[ -n "$ERRORS" ]]; then
            echo "The following checks failed:"
            echo "$ERRORS"
            exit 1
          fi

      # ------------------------------------------------------------
      # Summary
      # ------------------------------------------------------------
      - name: Generate summary
        if: always()
        run: |
          if [[ "${{ steps.changed-policies.outputs.has_changes }}" == "true" ]]; then
            echo "## üîç PR Checks Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changed policies:**" >> $GITHUB_STEP_SUMMARY
            
            while IFS= read -r policy; do
              [[ -z "$policy" ]] && continue
              echo "- \`$policy\`" >> $GITHUB_STEP_SUMMARY
            done <<< "${{ steps.changed-policies.outputs.policies }}"
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Checks performed:**" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Go formatting" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Import formatting" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Go vet" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Static analysis (staticcheck)" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Vulnerability check (govulncheck)" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Build verification" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Test execution (with race detection)" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Policy structure validation" >> $GITHUB_STEP_SUMMARY
          else
            echo "## üîç PR Checks Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No policy changes detected in this PR." >> $GITHUB_STEP_SUMMARY
          fi

      # ------------------------------------------------------------
      # Comment on PR if failed
      # ------------------------------------------------------------
      - name: Comment on PR if checks failed
        if: failure() && steps.changed-policies.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ‚ùå PR Checks Failed

            Some automated checks failed for the policies in this PR. Please review the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error messages.

            **Failed Checks:**
            ${process.env.ERRORS || 'Unknown errors occurred.'}

            **Common fixes:**
            - Run \`go fmt ./...\` to fix formatting issues
            - Run \`goimports -w .\` to fix import issues
            - Address any \`go vet\`, \`staticcheck\`, or build errors shown above

            The checks include: Go formatting, import formatting, vet, static analysis, vulnerability scanning, build verification, and tests.`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });