name: PR Checks

on:
  pull_request_target:
    branches:
      - main
      - '*.*.0'
    paths:
      - 'policies/**'

permissions:
  contents: read
  pull-requests: read

jobs:
  pr-checks:
    name: Go PR Validation
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.3"
          cache: false

      - name: Install Go tools
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go install honnef.co/go/tools/cmd/staticcheck@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest
          go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Detect changed policies
        id: policies
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          POLICIES=$(git diff --name-only "$BASE" "$HEAD" | grep '^policies/' | while read -r f; do
            d=$(dirname "$f")
            while [[ "$d" != "policies" && "$d" != "." ]]; do
              [[ -f "$d/go.mod" ]] && echo "${d#policies/}" && break
              d=$(dirname "$d")
            done
          done | sort -u)

          echo "Detected policies: $POLICIES"

          if [[ -z "$POLICIES" ]]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "policies<<EOF" >> $GITHUB_OUTPUT
            echo "$POLICIES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Build policies
        id: build
        if: steps.policies.outputs.has_changes == 'true'
        run: |
          BUILD_FAILED_FILE=$(mktemp)
          SUMMARY_FILE=$(mktemp)
          
          # Read policies line by line
          while IFS= read -r policy || [[ -n "$policy" ]]; do
            [[ -z "$policy" ]] && continue
            echo "Building policy: $policy"
            
            # Ensure we're in the repository root
            cd ${{ github.workspace }}
            
            if [[ -d "policies/$policy" ]]; then
              cd "policies/$policy"
              if ! go build . > build.out 2>&1; then
                echo "Build failed for $policy"
                echo true > $BUILD_FAILED_FILE
                echo "### $policy" >> $SUMMARY_FILE
                echo "- Build failed" >> $SUMMARY_FILE
                sed 's/^/  /' build.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Build successful for $policy"
              fi
            else
              echo "Directory not found for $policy"
              echo true > $BUILD_FAILED_FILE
              echo "### $policy" >> $SUMMARY_FILE
              echo "- Directory not found: policies/$policy" >> $SUMMARY_FILE
              echo "" >> $SUMMARY_FILE
            fi
          done <<< "${{ steps.policies.outputs.policies }}"
          
          SUMMARY=$(cat $SUMMARY_FILE)
          echo "build_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          if [ -f $BUILD_FAILED_FILE ]; then
            echo "build_failed=true" >> $GITHUB_OUTPUT
          else
            echo "build_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run checks on policies
        id: checks
        if: steps.policies.outputs.has_changes == 'true' && steps.build.outputs.build_failed != 'true'
        run: |
          SUMMARY_FILE=$(mktemp)
          
          # Read policies line by line
          while IFS= read -r policy || [[ -n "$policy" ]]; do
            [[ -z "$policy" ]] && continue
            echo "Checking policy: $policy"
            
            # Ensure we're in the repository root
            cd ${{ github.workspace }}
            
            if [[ -d "policies/$policy" ]]; then
              cd "policies/$policy"
              
              # Formatting check
              if ! goimports -d . > goimports.out 2>&1; then
                echo "Formatting failed for $policy"
                echo "### $policy" >> $SUMMARY_FILE
                echo "- Formatting failed" >> $SUMMARY_FILE
                sed 's/^/  /' goimports.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Formatting successful for $policy"
              fi
              
              # Static check
              if ! staticcheck ./... > staticcheck.out 2>&1; then
                echo "Static check failed for $policy"
                if ! grep -q "### $policy" $SUMMARY_FILE; then echo "### $policy" >> $SUMMARY_FILE; fi
                echo "- Static check failed" >> $SUMMARY_FILE
                sed 's/^/  /' staticcheck.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Static check successful for $policy"
              fi
              
              # Vulnerability check
              if ! govulncheck ./... > govulncheck.out 2>&1; then
                echo "Vulnerability check failed for $policy"
                if ! grep -q "### $policy" $SUMMARY_FILE; then echo "### $policy" >> $SUMMARY_FILE; fi
                echo "- Vulnerability check failed" >> $SUMMARY_FILE
                sed 's/^/  /' govulncheck.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Vulnerability check successful for $policy"
              fi
              
              # Gosec check
              if ! gosec ./... > gosec.out 2>&1; then
                echo "Gosec check failed for $policy"
                if ! grep -q "### $policy" $SUMMARY_FILE; then echo "### $policy" >> $SUMMARY_FILE; fi
                echo "- Gosec check failed" >> $SUMMARY_FILE
                sed 's/^/  /' gosec.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Gosec check successful for $policy"
              fi
              
              # Tests
              if ! go test ./... > test.out 2>&1; then
                echo "Tests failed for $policy"
                if ! grep -q "### $policy" $SUMMARY_FILE; then echo "### $policy" >> $SUMMARY_FILE; fi
                echo "- Tests failed" >> $SUMMARY_FILE
                sed 's/^/  /' test.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Tests successful for $policy"
              fi
              
              # Tests with race
              if ! go test -race ./... > test_race.out 2>&1; then
                echo "Tests with race failed for $policy"
                if ! grep -q "### $policy" $SUMMARY_FILE; then echo "### $policy" >> $SUMMARY_FILE; fi
                echo "- Tests with race failed" >> $SUMMARY_FILE
                sed 's/^/  /' test_race.out >> $SUMMARY_FILE
                echo "" >> $SUMMARY_FILE
              else
                echo "Tests with race successful for $policy"
              fi
            else
              echo "Directory not found for checks for $policy"
              echo "### $policy" >> $SUMMARY_FILE
              echo "- Directory not found for checks" >> $SUMMARY_FILE
              echo "" >> $SUMMARY_FILE
            fi
          done <<< "${{ steps.policies.outputs.policies }}"
          
          SUMMARY=$(cat $SUMMARY_FILE)
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate Summary
        if: steps.policies.outputs.has_changes == 'true'
        run: |
          echo "## PR Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ steps.build.outputs.build_summary }}" ]]; then
            echo "### Build Failures" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.build.outputs.build_summary }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ -n "${{ steps.checks.outputs.summary }}" ]]; then
            echo "### Check Failures" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.checks.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if build failed
        if: steps.build.outputs.build_failed == 'true'
        run: exit 1