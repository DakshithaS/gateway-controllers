name: PR Checks

on:
  pull_request_target:
    branches:
      - main
      - '*.*.0'
    paths:
      - 'policies/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-checks:
    name: Go PR Validation
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.x"
          cache: false

      - name: Install Go tools
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go install honnef.co/go/tools/cmd/staticcheck@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest
          go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Detect changed policies
        id: policies
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          # Get unique policy directories containing a go.mod
          POLICIES=$(git diff --name-only "$BASE" "$HEAD" | grep '^policies/' | while read -r f; do
            d=$(dirname "$f")
            while [[ "$d" != "policies" && "$d" != "." ]]; do
              [[ -f "$d/go.mod" ]] && echo "${d#policies/}" && break
              d=$(dirname "$d")
            done
          done | sort -u)

          if [[ -z "$POLICIES" ]]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            {
              echo "policies<<EOF"
              echo "$POLICIES"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Run Build and Checks
        id: checks
        if: steps.policies.outputs.has_changes == 'true'
        env:
          # Formatting
          ENABLE_FORMATTING: true
          REQUIRED_FORMATTING: false
          # Staticcheck
          ENABLE_STATICCHECK: true
          REQUIRED_STATICCHECK: false
          # Govulncheck
          ENABLE_GOVULNCHECK: true
          REQUIRED_GOVULNCHECK: false
          # Gosec
          ENABLE_GOSEC: true
          REQUIRED_GOSEC: false
        run: |
          FAILED=false
          OPTIONAL_FAILED=false
          echo "## üõ°Ô∏è PR Checks Summary" >> $GITHUB_STEP_SUMMARY
          
          while IFS= read -r policy || [[ -n "$policy" ]]; do
            [[ -z "$policy" ]] && continue
            
            echo "Processing $policy..."
            POLICY_DIR="${{ github.workspace }}/policies/$policy"

            echo "### $policy" >> $GITHUB_STEP_SUMMARY
            
            if [[ ! -d "$POLICY_DIR" ]]; then
              # echo "#### ‚ùå $policy" >> $GITHUB_STEP_SUMMARY
              echo "Directory not found." >> $GITHUB_STEP_SUMMARY
              FAILED=true
              continue
            fi

            cd "$POLICY_DIR"
            
            # --- 1. BUILD CHECK ---
            if ! build_out=$(go build . 2>&1); then
              echo "- #### Build Failed" >> $GITHUB_STEP_SUMMARY
              echo '```text' >> $GITHUB_STEP_SUMMARY
              echo "$build_out" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              FAILED=true
              continue # Skip further checks if build fails
            else
              echo "- #### Build Passed ‚úÖ" >> $GITHUB_STEP_SUMMARY
            fi

            # --- 2. LINT/TEST CHECKS ---
            # We collect all errors for this policy into a temporary variable
            CHECK_ERRORS=""

            # Formatting
            if [[ "${ENABLE_FORMATTING:-true}" == "true" ]]; then
              if ! fmt_out=$(goimports -d . 2>&1) || [[ -n "$fmt_out" ]]; then
                CHECK_ERRORS+=$'\n- #### Formatting Issues\n```diff\n'"$fmt_out"$'\n```\n'
                if [[ "${REQUIRED_FORMATTING:-false}" == "true" ]]; then
                  FAILED=true
                else
                  OPTIONAL_FAILED=true
                fi
              fi
            fi

            # Staticcheck
            if [[ "${ENABLE_STATICCHECK:-true}" == "true" ]]; then
              if ! sc_out=$(staticcheck ./... 2>&1); then
                CHECK_ERRORS+=$'\n- #### Static Analysis (staticcheck)\n```text\n'"$sc_out"$'\n```\n'
                if [[ "${REQUIRED_STATICCHECK:-false}" == "true" ]]; then
                  FAILED=true
                else
                  OPTIONAL_FAILED=true
                fi
              fi
            fi

            # Vulnerability check
            if [[ "${ENABLE_GOVULNCHECK:-false}" == "true" ]]; then
              if ! vuln_out=$(govulncheck ./... 2>&1); then
                CHECK_ERRORS+=$'\n- #### Vulnerability Check Failed\n```text\n'"$vuln_out"$'\n```\n'
                if [[ "${REQUIRED_GOVULNCHECK:-false}" == "true" ]]; then
                  FAILED=true
                else
                  OPTIONAL_FAILED=true
                fi
              fi
            fi

            # Security check
            if [[ "${ENABLE_GOSEC:-false}" == "true" ]]; then
              if ! gosec_out=$(gosec -exclude-dir=vendor -exclude-dir=test ./... 2>&1); then
                CHECK_ERRORS+=$'\n- #### Security Check (gosec) Failed\n```text\n'"$gosec_out"$'\n```\n'
                if [[ "${REQUIRED_GOSEC:-false}" == "true" ]]; then
                  FAILED=true
                else
                  OPTIONAL_FAILED=true
                fi
              fi
            fi

            # Tests
            if ! test_out=$(go test -race ./... 2>&1); then
              CHECK_ERRORS+=$'\n- #### Unit Tests Failed ‚ùå\n```text\n'"$test_out"$'\n```\n'
              FAILED=true
            fi

            # Finalize summary for this specific policy
            if [[ -n "$CHECK_ERRORS" ]]; then
              # echo "### ‚ö†Ô∏è Checks Failed: $policy" >> $GITHUB_STEP_SUMMARY
              echo "$CHECK_ERRORS" >> $GITHUB_STEP_SUMMARY
            else
              # echo "### ‚úÖ $policy" >> $GITHUB_STEP_SUMMARY
              echo "- All checks passed successfully ‚úÖ" >> $GITHUB_STEP_SUMMARY
            fi

          done <<< "${{ steps.policies.outputs.policies }}"

          echo "optional_failed=$OPTIONAL_FAILED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          # Fail the job if any required check failed
          if [ "$FAILED" = true ]; then
            exit 1
          fi

      - name: Comment on PR for optional failures
        if: steps.checks.outputs.optional_failed == 'true' && steps.checks.outputs.failed != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: "gh pr comment ${{ github.event.pull_request.number }} --body \"## ‚ö†Ô∏è Optional Checks Failed\n\nSome optional checks (formatting, static analysis, vulnerability, or security) failed. This does not block the merge, but please review the [job summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details and consider addressing them.\""
