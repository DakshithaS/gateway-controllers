name: PR Checks

on:
  pull_request_target:
    branches:
      - main
      - '*.*.0'
    paths:
      - 'policies/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-checks:
    name: Go PR Validation
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      PASS: "âœ…"
      FAIL: "âŒ"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.3"
          cache: false

      - name: Install Go tools
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go install honnef.co/go/tools/cmd/staticcheck@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest
          go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Detect changed policies
        id: policies
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          POLICIES=$(git diff --name-only "$BASE" "$HEAD" | grep '^policies/' | while read -r f; do
            d=$(dirname "$f")
            while [[ "$d" != "policies" && "$d" != "." ]]; do
              [[ -f "$d/go.mod" ]] && echo "${d#policies/}" && break
              d=$(dirname "$d")
            done
          done | sort -u)

          if [[ -z "$POLICIES" ]]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "policies<<EOF" >> $GITHUB_OUTPUT
            echo "$POLICIES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Run Validation Suite
        if: steps.policies.outputs.has_changes == 'true'
        run: |
          ROOT=$(pwd)
          # Initialize global status variables
          echo "ANY_FAILURE=false" >> $GITHUB_ENV
          
          # Create a detailed report card file
          echo "### ðŸ“„ Detailed Error Report" > report_card.md

          while read -r policy; do
            echo "Processing Policy: $policy"
            cd "$ROOT/policies/$policy" || continue
            POLICY_FAILED=false
            POLICY_ERRORS=""

            # --- Formatting ---
            if ! gofmt -l . | grep -q .; then
               fmt_res=$PASS
            else
               fmt_res=$FAIL; POLICY_FAILED=true; ANY_FAILURE=true
               POLICY_ERRORS+="- Formatting issues found\n"
            fi

            # --- Vet ---
            if go vet ./... > vet_err.log 2>&1; then
               vet_res=$PASS
            else
               vet_res=$FAIL; POLICY_FAILED=true; ANY_FAILURE=true
               POLICY_ERRORS+="- Go Vet: $(cat vet_err.log)\n"
            fi

            # --- Build ---
            if go build ./... > build_err.log 2>&1; then
               build_res=$PASS
            else
               build_res=$FAIL; POLICY_FAILED=true; ANY_FAILURE=true
               POLICY_ERRORS+="- Build Error: $(cat build_err.log)\n"
            fi

            # If this specific policy failed, add to report card
            if [ "$POLICY_FAILED" = true ]; then
               {
                 echo "#### $FAIL Policy: $policy"
                 echo -e "$POLICY_ERRORS"
                 echo "---"
               } >> "$ROOT/report_card.md"
            fi

            cd "$ROOT"
          done <<< "${{ steps.policies.outputs.policies }}"
          
          echo "ANY_FAILURE=$ANY_FAILURE" >> $GITHUB_ENV

      - name: PR Summary
        if: always()
        run: |
          echo "## ðŸ” PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f report_card.md ]; then
            cat report_card.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No changes or all checks passed!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Final Failure Gate
        if: steps.policies.outputs.has_changes == 'true'
        run: |
          if [ "$ANY_FAILURE" = "true" ]; then
            echo "Validation failed. See summary for details."
            exit 1
          fi