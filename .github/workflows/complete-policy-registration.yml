name: Complete Policy Registration

on:
  workflow_dispatch:
    inputs:
      policy:
        description: "Policy folder name"
        required: true
        type: string
      version:
        description: "Version (SemVer format: X.Y.Z)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  register-policy:
    name: Register Policy in Hub
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Input validation
      # ------------------------------------------------------------
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          POLICY="${{ github.event.inputs.policy }}"
          VERSION="${{ github.event.inputs.version }}"

          if ! [[ "$POLICY" =~ ^[a-zA-Z0-9-]+$ ]]; then
            echo "âŒ Invalid policy name: $POLICY"
            exit 1
          fi

          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(dev|rc)\.[0-9]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            exit 1
          fi

          echo "âœ… Inputs validated"

      # ------------------------------------------------------------
      # Resolve metadata
      # ------------------------------------------------------------
      - name: Resolve policy metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          POLICY="${{ github.event.inputs.policy }}"
          VERSION="${{ github.event.inputs.version }}"
          MAJOR="${VERSION%%.*}"
          
          # Determine paths
          if [[ "$MAJOR" == "0" || "$MAJOR" == "1" ]]; then
            TARGET_DIR="policies/$POLICY"
            MODULE_PATH="github.com/DakshithaS/gateway-controllers/policies/$POLICY"
          else
            TARGET_DIR="policies/$POLICY/v$MAJOR"
            MODULE_PATH="github.com/DakshithaS/gateway-controllers/policies/$POLICY/v$MAJOR"
          fi

          # Auto-resolve git tag
          GIT_TAG="policies/$POLICY/v$VERSION"

          # Verify tag exists
          if ! git tag -l | grep -qx "$GIT_TAG"; then
            echo "âŒ Git tag '$GIT_TAG' not found"
            echo "Available tags for this policy:"
            git tag -l | grep "policies/$POLICY/" || echo "No tags found"
            exit 1
          fi

          # Verify policy directory exists
          if [[ ! -d "$TARGET_DIR" ]]; then
            echo "âŒ Policy directory not found: $TARGET_DIR"
            exit 1
          fi

          echo "target_dir=$TARGET_DIR" >> "$GITHUB_OUTPUT"
          echo "module_path=$MODULE_PATH" >> "$GITHUB_OUTPUT"
          echo "git_tag=$GIT_TAG" >> "$GITHUB_OUTPUT"

          echo "âœ… Metadata resolved"
          echo "  Policy Directory: $TARGET_DIR"
          echo "  Module Path: $MODULE_PATH"
          echo "  Git Tag: $GIT_TAG"

      # ------------------------------------------------------------
      # Get commit SHA for the tag
      # ------------------------------------------------------------
      - name: Get tag commit SHA
        id: commit
        shell: bash
        run: |
          set -euo pipefail
          
          COMMIT_SHA=$(git rev-list -n 1 "${{ steps.meta.outputs.git_tag }}")
          echo "commit_sha=$COMMIT_SHA" >> "$GITHUB_OUTPUT"
          echo "âœ… Tag commit SHA: $COMMIT_SHA"

      # ------------------------------------------------------------
      # Verify Policy Hub configuration
      # ------------------------------------------------------------
      - name: Verify Policy Hub configuration
        shell: bash
        env:
          POLICY_HUB_URL: ${{ secrets.POLICY_HUB_URL }}
          POLICY_HUB_TOKEN: ${{ secrets.POLICY_HUB_TOKEN }}
        run: |
          set -euo pipefail

          if [[ -z "${POLICY_HUB_URL:-}" ]]; then
            echo "âŒ POLICY_HUB_URL secret not configured"
            echo "Configure this secret in repository settings"
            exit 1
          fi

          if [[ -z "${POLICY_HUB_TOKEN:-}" ]]; then
            echo "âŒ POLICY_HUB_TOKEN secret not configured"
            echo "Configure this secret in repository settings"
            exit 1
          fi

          echo "âœ… Policy Hub credentials configured"

      # ------------------------------------------------------------
      # Register with Policy Hub
      # ------------------------------------------------------------
      - name: Register policy in Policy Hub
        shell: bash
        env:
          POLICY_HUB_URL: ${{ secrets.POLICY_HUB_URL }}
          POLICY_HUB_TOKEN: ${{ secrets.POLICY_HUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "ðŸ“ Registering policy in Policy Hub..."

          # Create registration payload
          PAYLOAD=$(jq -n \
            --arg policy "${{ github.event.inputs.policy }}" \
            --arg version "${{ github.event.inputs.version }}" \
            --arg module_path "${{ steps.meta.outputs.module_path }}" \
            --arg git_tag "${{ steps.meta.outputs.git_tag }}" \
            --arg repository "${{ github.repository }}" \
            --arg commit_sha "${{ steps.commit.outputs.commit_sha }}" \
            --rawfile policy_def "${{ steps.meta.outputs.target_dir }}/policy-definition.yaml" \
            '{
              policy: $policy,
              version: $version,
              module_path: $module_path,
              git_tag: $git_tag,
              repository: $repository,
              commit_sha: $commit_sha,
              policy_definition: $policy_def,
              published_at: now | strftime("%Y-%m-%dT%H:%M:%SZ")
            }')

          echo "Registration payload prepared"

          # Make API call with detailed error handling
          HTTP_RESPONSE=$(curl -sSL -w "HTTPSTATUS:%{http_code}" \
            -X POST "$POLICY_HUB_URL/policies/register" \
            -H "Authorization: Bearer $POLICY_HUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          HTTP_STATUS=$(echo "$HTTP_RESPONSE" | tr -d '\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\1/')
          RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | sed -E 's/HTTPSTATUS:[0-9]{3}$//')

          if [[ "$HTTP_STATUS" =~ ^(200|201)$ ]]; then
            echo "âœ… Policy successfully registered in Policy Hub"
            echo "Response: $RESPONSE_BODY"
          else
            echo "âŒ Policy Hub registration failed (HTTP $HTTP_STATUS)"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi

      # ------------------------------------------------------------
      # Summary
      # ------------------------------------------------------------
      - name: Registration summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # âœ… Policy Registration Completed

          | Item | Value |
          |------|------|
          | Policy | \`${{ github.event.inputs.policy }}\` |
          | Version | \`${{ github.event.inputs.version }}\` |
          | Git Tag | \`${{ steps.meta.outputs.git_tag }}\` |
          | Module | \`${{ steps.meta.outputs.module_path }}\` |
          | Commit | \`${{ steps.commit.outputs.commit_sha }}\` |

          ## Status
          âœ… Policy Hub registration successful
          
          The policy is now registered and available in the Policy Hub.
          EOF